# E2E Testing Configuration
# Cypress and Playwright patterns

cypress_setup:
  installation: "npm install -D cypress"

  config: |
    // cypress.config.ts
    import { defineConfig } from 'cypress';

    export default defineConfig({
      e2e: {
        baseUrl: 'http://localhost:3000',
        supportFile: 'cypress/support/e2e.ts',
        specPattern: 'cypress/e2e/**/*.cy.{js,ts}',
        viewportWidth: 1280,
        viewportHeight: 720,
        video: true,
        screenshotOnRunFailure: true,
        retries: {
          runMode: 2,
          openMode: 0,
        },
      },
    });

  folder_structure: |
    cypress/
    ├── e2e/
    │   ├── auth.cy.ts
    │   └── dashboard.cy.ts
    ├── fixtures/
    │   └── users.json
    ├── support/
    │   ├── commands.ts
    │   └── e2e.ts
    └── downloads/

playwright_setup:
  installation: "npm install -D @playwright/test && npx playwright install"

  config: |
    // playwright.config.ts
    import { defineConfig, devices } from '@playwright/test';

    export default defineConfig({
      testDir: './tests',
      timeout: 30000,
      expect: { timeout: 5000 },
      fullyParallel: true,
      forbidOnly: !!process.env.CI,
      retries: process.env.CI ? 2 : 0,
      workers: process.env.CI ? 1 : undefined,
      reporter: 'html',
      use: {
        baseURL: 'http://localhost:3000',
        trace: 'on-first-retry',
        screenshot: 'only-on-failure',
        video: 'retain-on-failure',
      },
      projects: [
        { name: 'chromium', use: { ...devices['Desktop Chrome'] } },
        { name: 'firefox', use: { ...devices['Desktop Firefox'] } },
        { name: 'webkit', use: { ...devices['Desktop Safari'] } },
        { name: 'Mobile Chrome', use: { ...devices['Pixel 5'] } },
      ],
      webServer: {
        command: 'npm run dev',
        url: 'http://localhost:3000',
        reuseExistingServer: !process.env.CI,
      },
    });

cypress_tests:
  basic: |
    // cypress/e2e/login.cy.ts
    describe('Login', () => {
      beforeEach(() => {
        cy.visit('/login');
      });

      it('should login successfully', () => {
        cy.get('[data-testid="email"]').type('user@example.com');
        cy.get('[data-testid="password"]').type('password123');
        cy.get('[data-testid="submit"]').click();

        cy.url().should('include', '/dashboard');
        cy.contains('Welcome back').should('be.visible');
      });

      it('should show error for invalid credentials', () => {
        cy.get('[data-testid="email"]').type('invalid@example.com');
        cy.get('[data-testid="password"]').type('wrong');
        cy.get('[data-testid="submit"]').click();

        cy.contains('Invalid credentials').should('be.visible');
      });
    });

  custom_commands: |
    // cypress/support/commands.ts
    Cypress.Commands.add('login', (email: string, password: string) => {
      cy.visit('/login');
      cy.get('[data-testid="email"]').type(email);
      cy.get('[data-testid="password"]').type(password);
      cy.get('[data-testid="submit"]').click();
    });

    // Usage
    cy.login('user@example.com', 'password123');

  network_intercept: |
    cy.intercept('GET', '/api/users', { fixture: 'users.json' }).as('getUsers');
    cy.visit('/users');
    cy.wait('@getUsers');

    cy.intercept('POST', '/api/users', { statusCode: 201 }).as('createUser');

playwright_tests:
  basic: |
    // tests/login.spec.ts
    import { test, expect } from '@playwright/test';

    test.describe('Login', () => {
      test.beforeEach(async ({ page }) => {
        await page.goto('/login');
      });

      test('should login successfully', async ({ page }) => {
        await page.getByTestId('email').fill('user@example.com');
        await page.getByTestId('password').fill('password123');
        await page.getByTestId('submit').click();

        await expect(page).toHaveURL(/.*dashboard/);
        await expect(page.getByText('Welcome back')).toBeVisible();
      });

      test('should show error for invalid credentials', async ({ page }) => {
        await page.getByTestId('email').fill('invalid@example.com');
        await page.getByTestId('password').fill('wrong');
        await page.getByTestId('submit').click();

        await expect(page.getByText('Invalid credentials')).toBeVisible();
      });
    });

  fixtures: |
    // tests/fixtures/auth.fixture.ts
    import { test as base } from '@playwright/test';

    type AuthFixtures = {
      authenticatedPage: Page;
    };

    export const test = base.extend<AuthFixtures>({
      authenticatedPage: async ({ page }, use) => {
        await page.goto('/login');
        await page.getByTestId('email').fill('user@example.com');
        await page.getByTestId('password').fill('password123');
        await page.getByTestId('submit').click();
        await page.waitForURL(/.*dashboard/);
        await use(page);
      },
    });

    // Usage
    test('authenticated user can access dashboard', async ({ authenticatedPage }) => {
      await expect(authenticatedPage.getByText('Dashboard')).toBeVisible();
    });

  api_mocking: |
    await page.route('**/api/users', async (route) => {
      await route.fulfill({
        status: 200,
        body: JSON.stringify([{ id: 1, name: 'Test User' }]),
      });
    });

page_object_model:
  cypress: |
    // cypress/pages/LoginPage.ts
    export class LoginPage {
      visit() {
        cy.visit('/login');
      }

      fillEmail(email: string) {
        cy.get('[data-testid="email"]').type(email);
        return this;
      }

      fillPassword(password: string) {
        cy.get('[data-testid="password"]').type(password);
        return this;
      }

      submit() {
        cy.get('[data-testid="submit"]').click();
      }

      login(email: string, password: string) {
        this.fillEmail(email).fillPassword(password).submit();
      }
    }

    // Usage
    const loginPage = new LoginPage();
    loginPage.visit();
    loginPage.login('user@example.com', 'password123');

  playwright: |
    // pages/LoginPage.ts
    import { Page, Locator } from '@playwright/test';

    export class LoginPage {
      readonly emailInput: Locator;
      readonly passwordInput: Locator;
      readonly submitButton: Locator;

      constructor(private page: Page) {
        this.emailInput = page.getByTestId('email');
        this.passwordInput = page.getByTestId('password');
        this.submitButton = page.getByTestId('submit');
      }

      async goto() {
        await this.page.goto('/login');
      }

      async login(email: string, password: string) {
        await this.emailInput.fill(email);
        await this.passwordInput.fill(password);
        await this.submitButton.click();
      }
    }

visual_testing:
  playwright_screenshot: |
    await expect(page).toHaveScreenshot('homepage.png');
    await expect(page.getByTestId('header')).toHaveScreenshot('header.png');

    // Update screenshots
    npx playwright test --update-snapshots

ci_cd_integration:
  github_actions: |
    name: E2E Tests

    on: [push, pull_request]

    jobs:
      e2e:
        runs-on: ubuntu-latest
        steps:
          - uses: actions/checkout@v4

          - name: Setup Node.js
            uses: actions/setup-node@v4
            with:
              node-version: '20'
              cache: 'npm'

          - run: npm ci

          # Cypress
          - name: Cypress run
            uses: cypress-io/github-action@v6
            with:
              start: npm run dev
              wait-on: 'http://localhost:3000'

          # Playwright
          - name: Install Playwright
            run: npx playwright install --with-deps

          - name: Run Playwright tests
            run: npx playwright test

          - name: Upload report
            uses: actions/upload-artifact@v4
            if: always()
            with:
              name: playwright-report
              path: playwright-report/

best_practices:
  - "Use data-testid for stable selectors"
  - "Avoid testing implementation details"
  - "Keep tests independent"
  - "Use fixtures for test data"
  - "Implement Page Object Model"
  - "Run in CI/CD pipelines"
  - "Use retries for flaky tests"
  - "Generate reports for debugging"
